CREATE TABLE mart_head_to_head(
    team_id_1 integer,
    team_id_2 integer,
    team_1_name text,
    team_2_name text,
    total_matches bigint,
    team_1_wins bigint,
    draws bigint,
    team_2_wins bigint,
    team_1_goals bigint,
    team_2_goals bigint,
    team_1_avg_goals numeric,
    team_2_avg_goals numeric,
    last_meeting_date date,
    last_5_results text
);

-- Generated by the database client.
CREATE TABLE mart_team_season_summary(
    season_id integer,
    season_name text,
    season_year text,
    team_id integer,
    team_name text,
    matches_played bigint,
    wins bigint,
    draws bigint,
    losses bigint,
    total_points bigint,
    points_per_game numeric,
    goals_for bigint,
    goals_against bigint,
    goal_difference bigint,
    goals_per_game numeric,
    goals_conceded_per_game numeric,
    clean_sheets bigint,
    clean_sheet_percentage numeric,
    total_xg numeric,
    xg_per_game numeric,
    xg_difference numeric,
    xg_diff_per_game numeric,
    total_big_chances_created numeric,
    big_chances_created_per_game numeric,
    total_big_chances_missed numeric,
    big_chances_missed_per_game numeric,
    total_shots numeric,
    shots_per_game numeric,
    total_shots_on_target numeric,
    shots_on_target_per_game numeric,
    total_shots_inside_box numeric,
    shots_inside_box_per_game numeric,
    total_shots_outside_box numeric,
    shots_outside_box_per_game numeric,
    total_corners numeric,
    corners_per_game numeric,
    avg_dribbles_success_pct numeric,
    total_hit_woodwork numeric,
    total_saves numeric,
    saves_per_game numeric,
    total_tackles numeric,
    tackles_per_game numeric,
    avg_tackles_won_pct numeric,
    total_interceptions numeric,
    interceptions_per_game numeric,
    total_clearances numeric,
    clearances_per_game numeric,
    total_blocked_shots numeric,
    blocked_shots_per_game numeric,
    total_ball_recoveries numeric,
    ball_recoveries_per_game numeric,
    avg_aerial_duels_pct numeric,
    avg_ground_duels_pct numeric,
    avg_duels_won_pct numeric,
    total_errors_lead_to_goal numeric,
    total_errors_lead_to_shot numeric,
    avg_possession_pct numeric,
    total_accurate_passes numeric,
    total_passes numeric,
    pass_accuracy_pct numeric,
    accurate_passes_per_game numeric,
    total_passes_per_game numeric,
    total_accurate_long_balls numeric,
    accurate_long_balls_per_game numeric,
    total_accurate_crosses numeric,
    accurate_crosses_per_game numeric,
    total_final_third_entries numeric,
    final_third_entries_per_game numeric,
    total_touches_in_box_possession numeric,
    touches_in_box_per_game_possession numeric,
    total_dispossessed numeric,
    dispossessed_per_game numeric,
    total_yellow_cards numeric,
    yellow_cards_per_game numeric,
    total_red_cards numeric,
    total_fouls numeric,
    fouls_per_game numeric,
    total_offsides numeric,
    offsides_per_game numeric,
    total_free_kicks numeric,
    free_kicks_per_game numeric,
    last_5_results text,
    points_last_5 bigint,
    wins_last_5 bigint,
    draws_last_5 bigint,
    losses_last_5 bigint,
    goals_for_last_5 bigint,
    goals_against_last_5 bigint,
    halftime_leading_count bigint,
    halftime_leading_wins bigint,
    halftime_leading_win_pct numeric,
    conceded_first_count bigint,
    points_after_conceding_first bigint,
    points_pct_after_conceding_first numeric
);

-- Generated by the database client.
CREATE TABLE mart_team_attack(
    team_id integer,
    team_name text,
    season_id integer,
    season_name text,
    season_year text,
    matches_played bigint,
    total_goals bigint,
    goals_per_game numeric,
    total_xg numeric,
    xg_per_game numeric,
    xg_difference numeric,
    xg_diff_per_game numeric,
    total_big_chances_created numeric,
    big_chances_created_per_game numeric,
    total_big_chances_missed numeric,
    big_chances_missed_per_game numeric,
    total_big_chances_scored numeric,
    big_chances_scored_per_game numeric,
    total_shots_on_target numeric,
    shots_on_target_per_game numeric,
    total_shots_off_target numeric,
    shots_off_target_per_game numeric,
    total_blocked_shots numeric,
    blocked_shots_per_game numeric,
    total_shots numeric,
    shots_per_game numeric,
    total_shots_inside_box numeric,
    shots_inside_box_per_game numeric,
    total_shots_outside_box numeric,
    shots_outside_box_per_game numeric,
    total_hit_woodwork numeric,
    total_corners numeric,
    corners_per_game numeric,
    avg_dribbles_success_pct numeric,
    total_touches_in_box numeric,
    touches_in_box_per_game numeric
);

-- Generated by the database client.
CREATE TABLE mart_team_defense(
    team_id integer,
    team_name text,
    season_id integer,
    season_name text,
    season_year text,
    matches_played bigint,
    total_goals_conceded bigint,
    goals_conceded_per_game numeric,
    clean_sheets bigint,
    clean_sheet_pct numeric,
    total_saves numeric,
    saves_per_game numeric,
    total_tackles numeric,
    tackles_per_game numeric,
    avg_tackles_won_pct numeric,
    total_interceptions numeric,
    interceptions_per_game numeric,
    total_clearances numeric,
    clearances_per_game numeric,
    total_blocked_shots numeric,
    blocked_shots_per_game numeric,
    total_ball_recoveries numeric,
    ball_recoveries_per_game numeric,
    avg_aerial_duels_pct numeric,
    avg_ground_duels_pct numeric,
    avg_duels_won_pct numeric,
    total_errors_lead_to_goal numeric,
    total_errors_lead_to_shot numeric
);

-- Generated by the database client.
CREATE TABLE mart_team_form(
    team_id integer,
    team_name text,
    season_id integer,
    season_name text,
    season_year text,
    last_5_results text,
    points_last_5 bigint,
    wins_last_5 bigint,
    draws_last_5 bigint,
    losses_last_5 bigint,
    goals_for_last_5 bigint,
    goals_against_last_5 bigint,
    halftime_leading_count bigint,
    halftime_leading_wins bigint,
    halftime_leading_draws bigint,
    halftime_leading_losses bigint,
    halftime_leading_win_pct numeric,
    conceded_first_count bigint,
    points_after_conceding_first bigint,
    points_pct_after_conceding_first numeric
);

-- Generated by the database client.
CREATE TABLE mart_team_overview(
    season_id integer,
    season_name text,
    season_year text,
    team_id integer,
    team_name text,
    matches_played bigint,
    wins bigint,
    draws bigint,
    losses bigint,
    total_points bigint,
    points_per_game numeric,
    goals_for bigint,
    goals_against bigint,
    goal_difference bigint,
    goals_per_game numeric,
    goals_conceded_per_game numeric,
    clean_sheets bigint,
    clean_sheet_percentage numeric
);

-- Generated by the database client.
CREATE TABLE mart_team_possession(
    team_id integer,
    team_name text,
    season_id integer,
    season_name text,
    season_year text,
    matches_played bigint,
    avg_possession_pct numeric,
    total_accurate_passes numeric,
    total_passes numeric,
    accurate_passes_per_game numeric,
    total_passes_per_game numeric,
    pass_accuracy_pct numeric,
    total_accurate_long_balls numeric,
    accurate_long_balls_per_game numeric,
    total_accurate_crosses numeric,
    accurate_crosses_per_game numeric,
    total_final_third_entries numeric,
    final_third_entries_per_game numeric,
    total_touches_in_box numeric,
    touches_in_box_per_game numeric,
    total_dispossessed numeric,
    dispossessed_per_game numeric,
    total_throw_ins numeric,
    throw_ins_per_game numeric,
    total_goal_kicks numeric,
    goal_kicks_per_game numeric
);

-- Generated by the database client.
CREATE TABLE mart_team_discipline(
    team_id integer,
    team_name text,
    season_id integer,
    season_name text,
    season_year text,
    matches_played bigint,
    total_yellow_cards numeric,
    yellow_cards_per_game numeric,
    total_red_cards numeric,
    total_fouls numeric,
    fouls_per_game numeric,
    total_offsides numeric,
    offsides_per_game numeric,
    total_free_kicks numeric,
    free_kicks_per_game numeric
);

-- Generated by the database client.
CREATE TABLE mart_match_predictions(
    match_id integer,
    match_date date,
    season_id integer,
    season_name text,
    season_year text,
    home_team_id integer,
    home_team_name text,
    away_team_id integer,
    away_team_name text,
    tournament_name text,
    home_avg_goals_scored_home numeric,
    home_avg_goals_conceded_home numeric,
    home_avg_xg_home numeric,
    home_avg_shots_on_target_home numeric,
    home_avg_possession_home numeric,
    home_win_rate_home numeric,
    home_points_last_5 bigint,
    home_wins_last_5 bigint,
    home_goals_for_last_5 bigint,
    home_goals_against_last_5 bigint,
    away_avg_goals_scored_away numeric,
    away_avg_goals_conceded_away numeric,
    away_avg_xg_away numeric,
    away_avg_shots_on_target_away numeric,
    away_avg_possession_away numeric,
    away_win_rate_away numeric,
    away_points_last_5 bigint,
    away_wins_last_5 bigint,
    away_goals_for_last_5 bigint,
    away_goals_against_last_5 bigint,
    predicted_home_goals numeric,
    predicted_away_goals numeric,
    predicted_total_xg numeric,
    match_outlook text,
    home_win_probability numeric,
    draw_probability numeric,
    away_win_probability numeric,
    home_win_fair_odds numeric,
    draw_fair_odds numeric,
    away_win_fair_odds numeric,
    actual_home_score integer,
    actual_away_score integer,
    actual_result text,
    prediction_correct boolean,
    home_goals_error numeric,
    away_goals_error numeric
);

WITH match_data AS (
         SELECT fm.season_id,
            fm.season_name,
            fm.season_year,
            fm.match_id,
            fm.match_date,
            fm.home_team_id,
            fm.home_team_name,
            fm.away_team_id,
            fm.away_team_name,
            fm.home_score,
            fm.away_score,
            fm.winner_code,
                CASE
                    WHEN ((fm.home_score > 0) AND (fm.away_score > 0)) THEN 1
                    ELSE 0
                END AS btts,
                CASE
                    WHEN (fm.away_score = 0) THEN 1
                    ELSE 0
                END AS home_clean_sheet,
                CASE
                    WHEN (fm.home_score = 0) THEN 1
                    ELSE 0
                END AS away_clean_sheet,
            COALESCE(ftm_home.stat_expectedgoals, (0)::numeric) AS home_xg,
            COALESCE(ftm_away.stat_expectedgoals, (0)::numeric) AS away_xg
           FROM ((silver.fact_match fm
             LEFT JOIN silver.fact_team_match ftm_home ON (((fm.match_id = ftm_home.match_id) AND (fm.home_team_id = ftm_home.team_id) AND (ftm_home.period = 'ALL'::text))))
             LEFT JOIN silver.fact_team_match ftm_away ON (((fm.match_id = ftm_away.match_id) AND (fm.away_team_id = ftm_away.team_id) AND (ftm_away.period = 'ALL'::text))))
          WHERE (fm.status_type = 'finished'::text)
        ), team_overall_stats AS (
         SELECT all_matches.team_id,
            all_matches.team_name,
            all_matches.season_id,
            all_matches.season_name,
            all_matches.season_year,
            count(*) AS matches_played,
            (((sum(
                CASE
                    WHEN (all_matches.is_win = 1) THEN 1
                    ELSE 0
                END))::numeric / (NULLIF(count(*), 0))::numeric) * (100)::numeric) AS win_pct,
            round(avg(all_matches.goals_for), 2) AS avg_goals_per_match,
            round(avg(all_matches.goals_for), 2) AS avg_scored,
            round(avg(all_matches.goals_against), 2) AS avg_conceded,
            (((sum(all_matches.btts))::numeric / (NULLIF(count(*), 0))::numeric) * (100)::numeric) AS btts_pct,
            (((sum(all_matches.clean_sheet))::numeric / (NULLIF(count(*), 0))::numeric) * (100)::numeric) AS clean_sheet_pct,
            round(avg(all_matches.xg_for), 2) AS avg_xg,
            round(avg(all_matches.xg_against), 2) AS avg_xga
           FROM ( SELECT match_data.home_team_id AS team_id,
                    match_data.home_team_name AS team_name,
                    match_data.season_id,
                    match_data.season_name,
                    match_data.season_year,
                    match_data.home_score AS goals_for,
                    match_data.away_score AS goals_against,
                        CASE
                            WHEN (match_data.winner_code = 1) THEN 1
                            ELSE 0
                        END AS is_win,
                    match_data.btts,
                    match_data.home_clean_sheet AS clean_sheet,
                    match_data.home_xg AS xg_for,
                    match_data.away_xg AS xg_against
                   FROM match_data
                UNION ALL
                 SELECT match_data.away_team_id AS team_id,
                    match_data.away_team_name AS team_name,
                    match_data.season_id,
                    match_data.season_name,
                    match_data.season_year,
                    match_data.away_score AS goals_for,
                    match_data.home_score AS goals_against,
                        CASE
                            WHEN (match_data.winner_code = 2) THEN 1
                            ELSE 0
                        END AS is_win,
                    match_data.btts,
                    match_data.away_clean_sheet AS clean_sheet,
                    match_data.away_xg AS xg_for,
                    match_data.home_xg AS xg_against
                   FROM match_data) all_matches
          GROUP BY all_matches.team_id, all_matches.team_name, all_matches.season_id, all_matches.season_name, all_matches.season_year
        ), team_home_stats AS (
         SELECT match_data.home_team_id AS team_id,
            match_data.home_team_name AS team_name,
            match_data.season_id,
            match_data.season_name,
            match_data.season_year,
            count(*) AS home_matches_played,
            (((sum(
                CASE
                    WHEN (match_data.winner_code = 1) THEN 1
                    ELSE 0
                END))::numeric / (NULLIF(count(*), 0))::numeric) * (100)::numeric) AS home_win_pct,
            round(avg((match_data.home_score + match_data.away_score)), 2) AS home_avg_goals_per_match,
            round(avg(match_data.home_score), 2) AS home_avg_scored,
            round(avg(match_data.away_score), 2) AS home_avg_conceded,
            (((sum(match_data.btts))::numeric / (NULLIF(count(*), 0))::numeric) * (100)::numeric) AS home_btts_pct,
            (((sum(match_data.home_clean_sheet))::numeric / (NULLIF(count(*), 0))::numeric) * (100)::numeric) AS home_clean_sheet_pct,
            round(avg(match_data.home_xg), 2) AS home_avg_xg,
            round(avg(match_data.away_xg), 2) AS home_avg_xga
           FROM match_data
          GROUP BY match_data.home_team_id, match_data.home_team_name, match_data.season_id, match_data.season_name, match_data.season_year
        ), team_away_stats AS (
         SELECT match_data.away_team_id AS team_id,
            match_data.away_team_name AS team_name,
            match_data.season_id,
            match_data.season_name,
            match_data.season_year,
            count(*) AS away_matches_played,
            (((sum(
                CASE
                    WHEN (match_data.winner_code = 2) THEN 1
                    ELSE 0
                END))::numeric / (NULLIF(count(*), 0))::numeric) * (100)::numeric) AS away_win_pct,
            round(avg((match_data.home_score + match_data.away_score)), 2) AS away_avg_goals_per_match,
            round(avg(match_data.away_score), 2) AS away_avg_scored,
            round(avg(match_data.home_score), 2) AS away_avg_conceded,
            (((sum(match_data.btts))::numeric / (NULLIF(count(*), 0))::numeric) * (100)::numeric) AS away_btts_pct,
            (((sum(match_data.away_clean_sheet))::numeric / (NULLIF(count(*), 0))::numeric) * (100)::numeric) AS away_clean_sheet_pct,
            round(avg(match_data.away_xg), 2) AS away_avg_xg,
            round(avg(match_data.home_xg), 2) AS away_avg_xga
           FROM match_data
          GROUP BY match_data.away_team_id, match_data.away_team_name, match_data.season_id, match_data.season_name, match_data.season_year
        )
 SELECT ov.team_id,
    ov.team_name,
    ov.season_id,
    ov.season_name,
    ov.season_year,
    ov.matches_played,
    round(ov.win_pct, 1) AS overall_win_pct,
    ov.avg_goals_per_match AS overall_avg_goals_per_match,
    ov.avg_scored AS overall_avg_scored,
    ov.avg_conceded AS overall_avg_conceded,
    round(ov.btts_pct, 1) AS overall_btts_pct,
    round(ov.clean_sheet_pct, 1) AS overall_clean_sheet_pct,
    ov.avg_xg AS overall_avg_xg,
    ov.avg_xga AS overall_avg_xga,
    hs.home_matches_played,
    round(hs.home_win_pct, 1) AS home_win_pct,
    hs.home_avg_goals_per_match,
    hs.home_avg_scored,
    hs.home_avg_conceded,
    round(hs.home_btts_pct, 1) AS home_btts_pct,
    round(hs.home_clean_sheet_pct, 1) AS home_clean_sheet_pct,
    hs.home_avg_xg,
    hs.home_avg_xga,
    aws.away_matches_played,
    round(aws.away_win_pct, 1) AS away_win_pct,
    aws.away_avg_goals_per_match,
    aws.away_avg_scored,
    aws.away_avg_conceded,
    round(aws.away_btts_pct, 1) AS away_btts_pct,
    round(aws.away_clean_sheet_pct, 1) AS away_clean_sheet_pct,
    aws.away_avg_xg,
    aws.away_avg_xga
   FROM ((team_overall_stats ov
     LEFT JOIN team_home_stats hs ON (((ov.team_id = hs.team_id) AND (ov.season_id = hs.season_id))))
     LEFT JOIN team_away_stats aws ON (((ov.team_id = aws.team_id) AND (ov.season_id = aws.season_id))))
  ORDER BY ov.season_year DESC, (round(ov.btts_pct, 1)) DESC;